<!DOCTYPE html>
<html lang="en" ng-app="app">
<head>
  <meta charset="UTF-8">
  <title>Rdy.Today</title>
  <meta name=viewport content="width=device-width, initial-scale=1,minimum-scale=1.0, user-scalable=no">
  <base href="/">
  <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
  <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" integrity="sha384-wvfXpqpZZVQGK6TAh5PVlGOfQNHSoD2xbE+QkPxCAFlNEevoEH3Sl0sibVcOQVnN" crossorigin="anonymous">
  <style>
    body {
      padding: 20px;
    }

    .northern {
      background: #000;
      color: #FFF;
    }

    .bakerloo {
      background: #894e24;
      color: #FFF;
    }

    .central {
      background: #dc241f;
    }

    .circle {
      background: #ffce00;
    }

    .district {
      background: #007229;
      color: #FFF;
    }

    .hammersmith, .hammersmith-city {
      background: #d799af;
    }

    .jubilee {
      background: #6a7278;
      color: #FFF;
    }

    .metropolitan {
      background: #751056;
      color: #FFF;
    }

    .piccadilly {
      background: #0019a8;
      color: #FFF;
    }

    .victoria {
      background: #00a0e2;
    }

    .waterloo, .waterloo-city {
      background: #76d0bd;
    }

    .overground {
      background: #e86a10;
    }

    .dlr {
      background: #00afad;
    }

    .rain::after {
      background: rgba(51, 122, 183, 0.3);
      content: '';
      height: 100%;
      /*width: 100%;*/
      /* color: red; */
      position: absolute;
      bottom: 0;
      left: 0;
    }

    .rain-10::after {
      width: 10%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-20::after {
      width: 20%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-30::after {
      width: 30%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-40::after {
      width: 40%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-50::after {
      width: 50%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-60::after {
      width: 60%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-70::after {
      width: 70%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-80::after {
      width: 80%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-90::after {
      width: 90%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .rain-100::after {
      width: 100%;
      border-right: 1px solid rgba(51, 122, 183, 0.5);
    }

    .okay {
      color: green;
    }
  </style>
</head>
<body ng-controller="HomeController">

<div class="list-group">
  <div class="list-group-item">
    <h4 class="list-group-item-heading">Next trains to London Bridge from Lewisham</h4>
    <div class="list-group-item-text">
      <div class="list-group">
        <div ng-repeat="item in data.rail" class="list-group-item">
          {{item.std}}
          <strong ng-if="item.etd !== 'On time'"> ({{item.etd}})</strong>
          <span>/ platform {{item.platform || 'unknown'}}</span>
        </div>
      </div>
    </div>
  </div>
  <div class="list-group-item">
    <h4 class="list-group-item-heading">Tube Status</h4>
    <div class="list-group-item-text">
      <div class="list-group">
        <div class="list-group-item text-center {{item.line}}" ng-repeat="item in data.tube">
          <i class="fa fa-check-circle" aria-hidden="true" ng-if="item.status == 10"></i>
          <i class="fa fa-exclamation-circle" aria-hidden="true" ng-if="item.status!= 10"></i>
          <div ng-if="item.disruption">
            {{item.disruption}}
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="list-group-item">
    <h4 class="list-group-item-heading">Weather</h4>
    <div class="list-group-item-text">
      <div class="list-group">
        <div class="list-group-item rain rain-{{item.pop}}" ng-repeat="item in data.weather">
          {{item.hour}}:00 {{item.feelsLike}}Â° / ({{item.pop}}% chance of rain)
        </div>
      </div>
    </div>
  </div>
</div>
</body>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.4/angular.min.js"></script>
<script>
  var app = angular.module('app', []);

  app.controller('HomeController', ['$scope', 'Tube', 'Weather', 'NationalRail', function ($scope, Tube, Weather, NationalRail) {
    $scope.data = {
      weather: null,
      tube: null,
      rail: null
    };

    Tube.get().then(function (response) {
      $scope.data.tube = response;
    });
    Weather.get().then(function (response) {
      $scope.data.weather = response;
    });
    NationalRail.get().then(function (response) {
      $scope.data.rail = response;
    });
  }]);

  app.factory('Tube', ['$http', '$q', function ($http, $q) {
    var severityMap = [
      "Special Service",
      "Closed",
      "Suspended",
      "Part Suspended",
      "Planned Closure",
      "Part Closure",
      "Severe Delays",
      "Reduced Service",
      "Bus Service",
      "Minor Delays",
      "Good Service",
      "Part Closed",
      "Exist Only",
      "No Step Free Access",
      "Change of frequency",
      "Diverted",
      "Not Running",
      "Issues Reported",
      "No Issues",
      "Information",
      "Service Closed"
    ];

    function cleanData(response) {
      var toReturn = [];

      angular.forEach(response.data, function (object, index) {
        toReturn.push({
          line: object.id,
          status: object.lineStatuses[0].statusSeverity,
          disruption: object.lineStatuses[0].disruption ? object.lineStatuses[0].disruption.description : null
        });
      });

      return toReturn;
    }

    return {
      get: function () {
        var def = $q.defer();
        $http.get('https://api.tfl.gov.uk/line/mode/tube/status').then(function (response) {
          def.resolve(cleanData(response))
        });
        return def.promise;
      },
      statusToText: function (level) {
        return severityMap[level];
      }
    };
  }]);

  app.factory('Weather', ['$http', '$q', function ($http, $q) {
    function cleanData(response) {
      // pop = possibility of precipitation
      var counter = 0;
      var toReturn = [];

      angular.forEach(response.data.hourly_forecast, function (object, index) {
        if (counter >= 12) {
          return true;
        }

        toReturn.push({
          hour: object.FCTTIME.hour_padded,
          temperature: object.temp.metric,
          feelsLike: object.feelslike.metric,
          pop: Math.round(object.pop / 10) * 10 //parseInt(object.pop / 10, 10) + 10
        });
        counter++;
      });

      return toReturn;
    }

    return {
      get: function () {
        var def = $q.defer();
        $http.get('http://api.wunderground.com/api/44e5245ea7ad9ad5/hourly/q/GB/London.json').then(function (response) {
          def.resolve(cleanData(response))
        });
        return def.promise;
      }
    };
  }]);

  app.factory('NationalRail', ['$http', '$q', function ($http, $q) {
    function cleanData(response) {
      var toReturn = [];

      angular.forEach(response.data.trainServices, function (object, index) {
        toReturn.push({
          from: object.origin[0].locationName,
          to: object.destination[0].locationName,
          std: object.std,
          etd: object.etd,
          platform: object.platform,
          cancelReason: object.cancelReason,
          delayReason: object.delayReason
        });
      });

      return toReturn;
    }

    return {
      get: function () {
        var def = $q.defer();
        $http.get('https://huxley.apphb.com/departures/lew/to/lbg/5?accessToken=fc769847-9533-4832-b89c-9751ef2ffd53').then(function (response) {
          def.resolve(cleanData(response))
        });
        return def.promise;
      }
    };
  }]);
</script>
</html>